# =============================================================================
# API Deployment — FastAPI / Uvicorn
# =============================================================================
#
# Scaling strategy:
#   - 3 replicas minimum for high availability (tolerates one node failure)
#   - HPA scales up to 10 replicas based on CPU utilisation + RPS
#   - PodDisruptionBudget ensures at least 2 replicas during node drain
#
# Security:
#   - Non-root user (runAsUser: 1001)
#   - Read-only root filesystem
#   - Dropped ALL Linux capabilities
#   - No privilege escalation
#
# Health probes:
#   - startupProbe  : 60s grace period for model loading
#   - livenessProbe : restart if the event loop is deadlocked
#   - readinessProbe: remove from load balancer if unhealthy
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: rag-api
  namespace: rag-platform
  labels:
    app.kubernetes.io/name:      rag-platform
    app.kubernetes.io/component: api
    version: "1.0.0"
spec:
  replicas: 3
  selector:
    matchLabels:
      app.kubernetes.io/component: api
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge:       1     # temporarily allow 4 pods during update
      maxUnavailable: 0     # never go below 3 healthy pods
  template:
    metadata:
      labels:
        app.kubernetes.io/name:      rag-platform
        app.kubernetes.io/component: api
      annotations:
        # Prometheus scraping
        prometheus.io/scrape: "true"
        prometheus.io/port:   "8000"
        prometheus.io/path:   "/metrics"
    spec:
      # Spread pods across availability zones
      topologySpreadConstraints:
        - maxSkew:           1
          topologyKey:       topology.kubernetes.io/zone
          whenUnsatisfiable: DoNotSchedule
          labelSelector:
            matchLabels:
              app.kubernetes.io/component: api

      # Use IRSA service account for AWS SDK calls (S3, KMS, Bedrock)
      serviceAccountName: rag-api-sa

      securityContext:
        runAsNonRoot: true
        runAsUser:    1001
        runAsGroup:   1001
        fsGroup:      1001

      containers:
        - name: api
          image: "YOUR_ECR_REPO/rag-platform/api:latest"   # ← set in CI/CD
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8000
              protocol: TCP

          envFrom:
            - configMapRef:
                name: rag-platform-config
            - secretRef:
                name: rag-platform-secrets   # managed by external-secrets

          resources:
            requests:
              cpu:    "500m"
              memory: "512Mi"
            limits:
              cpu:    "2"
              memory: "2Gi"

          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem:   true
            capabilities:
              drop: ["ALL"]

          # Temporary directories needed by uvicorn / langchain
          volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: cache
              mountPath: /home/appuser/.cache

          # --------------- Health Probes ---------------
          startupProbe:
            httpGet:
              path:   /health
              port:   http
            failureThreshold: 12   # 12 × 10s = 120s startup grace
            periodSeconds:    10

          livenessProbe:
            httpGet:
              path:   /health
              port:   http
            initialDelaySeconds: 0
            periodSeconds:      15
            timeoutSeconds:     5
            failureThreshold:   3

          readinessProbe:
            httpGet:
              path:   /health/ready
              port:   http
            initialDelaySeconds: 5
            periodSeconds:      10
            timeoutSeconds:     5
            failureThreshold:   2

      volumes:
        - name: tmp
          emptyDir: {}
        - name: cache
          emptyDir: {}

      terminationGracePeriodSeconds: 30
---
# =============================================================================
# Service — expose API within the cluster
# =============================================================================
apiVersion: v1
kind: Service
metadata:
  name: rag-api
  namespace: rag-platform
  labels:
    app.kubernetes.io/name:      rag-platform
    app.kubernetes.io/component: api
spec:
  selector:
    app.kubernetes.io/component: api
  ports:
    - name:       http
      port:       80
      targetPort: http
      protocol:   TCP
  type: ClusterIP
---
# =============================================================================
# PodDisruptionBudget — ensure availability during node drain
# =============================================================================
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: rag-api-pdb
  namespace: rag-platform
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app.kubernetes.io/component: api
