##############################################################
# Auto-Deploy to AWS
# Triggers every time you push code to the main branch.
#
# What it does:
#   1. Runs your tests
#   2. Builds Docker images
#   3. Pushes images to AWS ECR
#   4. Runs database migrations
#   5. Deploys updated containers to ECS
#
# Configuration values are read from EITHER:
#   - GitHub repository Secrets  (Settings â†’ Secrets â†’ Actions)
#   - GitHub repository Variables (Settings â†’ Variables â†’ Actions)
# Secrets take priority. This way the workflow works regardless
# of which storage type you chose when following the setup guide.
##############################################################

name: Deploy to AWS

on:
  push:
    branches: [main]          # Auto-deploy on every push to main
  workflow_dispatch:          # Also allow manual trigger from GitHub UI

jobs:

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1 â€” Run Tests
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER:     rag
          POSTGRES_PASSWORD: rag
          POSTGRES_DB:       ragplatform_test
        ports: ["5432:5432"]
        options: >-
          --health-cmd pg_isready
          --health-interval 5s
          --health-timeout 3s
          --health-retries 10

      redis:
        image: redis:7-alpine
        ports: ["6379:6379"]
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip
          cache-dependency-path: backend/requirements.txt

      - name: Install Python dependencies
        working-directory: backend
        run: pip install -r requirements.txt

      - name: Run tests
        working-directory: backend
        env:
          DATABASE_URL:         postgresql+asyncpg://rag:rag@localhost:5432/ragplatform_test
          REDIS_URL:            redis://localhost:6379/0
          AUTH_ISSUER:          https://test.auth.example.com/
          AUTH_AUDIENCE:        test-api-audience
          OPENAI_API_KEY:       sk-test-placeholder
          S3_BUCKET:            test-bucket
          AWS_REGION:           us-east-1
          AWS_ACCESS_KEY_ID:    test
          AWS_SECRET_ACCESS_KEY: test
          VECTOR_STORE_BACKEND: weaviate
          WEAVIATE_HOST:        localhost
          WEAVIATE_PORT:        "8080"
          WEAVIATE_API_KEY:     ""
          APP_ENV:              test
          DEBUG:                "true"
        run: python -m pytest -m "unit or integration" --tb=short -q --timeout=60

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2 â€” Build and Push Docker Images
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  build:
    name: ðŸ³ Build & Push Images
    runs-on: ubuntu-latest
    needs: test                # Only runs if tests pass

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ secrets.AWS_REGION || vars.AWS_REGION }}

      - name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@v2

      - name: Set up Docker Buildx (for faster builds with caching)
        uses: docker/setup-buildx-action@v3

      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context:    ./backend
          file:       ./backend/Dockerfile
          target:     api
          push:       true
          tags: |
            ${{ secrets.ECR_API_URL || vars.ECR_API_URL }}:${{ github.sha }}
            ${{ secrets.ECR_API_URL || vars.ECR_API_URL }}:latest
          cache-from: type=gha,scope=api
          cache-to:   type=gha,scope=api,mode=max

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push:    true
          build-args: |
            NEXT_PUBLIC_APP_VERSION=${{ github.sha }}
          tags: |
            ${{ secrets.ECR_FRONTEND_URL || vars.ECR_FRONTEND_URL }}:${{ github.sha }}
            ${{ secrets.ECR_FRONTEND_URL || vars.ECR_FRONTEND_URL }}:latest
          cache-from: type=gha,scope=frontend
          cache-to:   type=gha,scope=frontend,mode=max

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3 â€” Run Database Migrations
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  migrate:
    name: ðŸ—„ï¸ Run Migrations
    runs-on: ubuntu-latest
    needs: build               # Only runs after images are pushed

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ secrets.AWS_REGION || vars.AWS_REGION }}

      - name: Run database migrations
        env:
          ECS_CLUSTER:            ${{ secrets.ECS_CLUSTER            || vars.ECS_CLUSTER }}
          ECS_MIGRATION_TASK_DEF: ${{ secrets.ECS_MIGRATION_TASK_DEF || vars.ECS_MIGRATION_TASK_DEF }}
          ECS_PRIVATE_SUBNET:     ${{ secrets.ECS_PRIVATE_SUBNET     || vars.ECS_PRIVATE_SUBNET }}
          ECS_SECURITY_GROUP:     ${{ secrets.ECS_SECURITY_GROUP     || vars.ECS_SECURITY_GROUP }}
          ECR_API_URL:            ${{ secrets.ECR_API_URL            || vars.ECR_API_URL }}
          IMAGE_TAG:              ${{ github.sha }}
        run: |
          echo "Starting migration task in ECS..."

          TASK_ARN=$(aws ecs run-task \
            --cluster  "$ECS_CLUSTER" \
            --task-definition "$ECS_MIGRATION_TASK_DEF" \
            --launch-type FARGATE \
            --network-configuration "awsvpcConfiguration={subnets=[$ECS_PRIVATE_SUBNET],securityGroups=[$ECS_SECURITY_GROUP],assignPublicIp=DISABLED}" \
            --overrides "{\"containerOverrides\":[{\"name\":\"migration\",\"image\":\"$ECR_API_URL:$IMAGE_TAG\"}]}" \
            --query 'tasks[0].taskArn' \
            --output text)

          echo "Task ARN: $TASK_ARN"
          echo "Waiting for migrations to complete..."

          aws ecs wait tasks-stopped \
            --cluster "$ECS_CLUSTER" \
            --tasks   "$TASK_ARN"

          EXIT_CODE=$(aws ecs describe-tasks \
            --cluster "$ECS_CLUSTER" \
            --tasks   "$TASK_ARN" \
            --query   'tasks[0].containers[0].exitCode' \
            --output  text)

          echo "Migration exit code: $EXIT_CODE"

          if [ "$EXIT_CODE" != "0" ]; then
            echo "âŒ Migration FAILED (exit code $EXIT_CODE)"
            echo "Check logs at: AWS Console â†’ CloudWatch â†’ Log groups â†’ /ecs/.../migration"
            exit 1
          fi

          echo "âœ… Migrations completed successfully"

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 4 â€” Deploy to ECS
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: ðŸš€ Deploy to AWS
    runs-on: ubuntu-latest
    needs: migrate             # Only runs after migrations succeed

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ secrets.AWS_REGION || vars.AWS_REGION }}

      # Resolve all config values once into env vars for this job
      - name: Resolve configuration
        run: |
          echo "ECS_CLUSTER=${{ secrets.ECS_CLUSTER || vars.ECS_CLUSTER }}"                   >> $GITHUB_ENV
          echo "ECS_API_SERVICE=${{ secrets.ECS_API_SERVICE || vars.ECS_API_SERVICE }}"       >> $GITHUB_ENV
          echo "ECS_WORKER_SERVICE=${{ secrets.ECS_WORKER_SERVICE || vars.ECS_WORKER_SERVICE }}" >> $GITHUB_ENV
          echo "ECS_FRONTEND_SERVICE=${{ secrets.ECS_FRONTEND_SERVICE || vars.ECS_FRONTEND_SERVICE }}" >> $GITHUB_ENV
          echo "ECR_API_URL=${{ secrets.ECR_API_URL || vars.ECR_API_URL }}"                   >> $GITHUB_ENV
          echo "ECR_FRONTEND_URL=${{ secrets.ECR_FRONTEND_URL || vars.ECR_FRONTEND_URL }}"   >> $GITHUB_ENV

      # â”€â”€ Deploy API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Get current API task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition "${{ env.ECS_CLUSTER }}-api" \
            --query taskDefinition \
            --output json > api-task-def.json

      - name: Update API image in task definition
        id: api-task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: api-task-def.json
          container-name:  api
          image:           ${{ env.ECR_API_URL }}:${{ github.sha }}

      - name: Deploy API service
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition:            ${{ steps.api-task-def.outputs.task-definition }}
          service:                    ${{ env.ECS_API_SERVICE }}
          cluster:                    ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true

      # â”€â”€ Deploy Worker â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Get current Worker task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition "${{ env.ECS_CLUSTER }}-worker" \
            --query taskDefinition \
            --output json > worker-task-def.json

      - name: Update Worker image in task definition
        id: worker-task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: worker-task-def.json
          container-name:  worker
          image:           ${{ env.ECR_API_URL }}:${{ github.sha }}

      - name: Deploy Worker service
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition:            ${{ steps.worker-task-def.outputs.task-definition }}
          service:                    ${{ env.ECS_WORKER_SERVICE }}
          cluster:                    ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: false

      # â”€â”€ Deploy Frontend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Get current Frontend task definition
        run: |
          aws ecs describe-task-definition \
            --task-definition "${{ env.ECS_CLUSTER }}-frontend" \
            --query taskDefinition \
            --output json > frontend-task-def.json

      - name: Update Frontend image in task definition
        id: frontend-task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: frontend-task-def.json
          container-name:  frontend
          image:           ${{ env.ECR_FRONTEND_URL }}:${{ github.sha }}

      - name: Deploy Frontend service
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition:            ${{ steps.frontend-task-def.outputs.task-definition }}
          service:                    ${{ env.ECS_FRONTEND_SERVICE }}
          cluster:                    ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true

      # â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Print deployment summary
        run: |
          echo "## âœ… Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service  | Image Tag |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| API      | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Worker   | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Commit: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
